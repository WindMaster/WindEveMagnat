<?xml version="1.0" encoding="utf-8" ?>
<sqlMap namespace="WindEveMagnat.Persistence" xmlns="http://ibatis.apache.org/mapping" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" >
	<statements>
		<statement id="GetEveItemById" parameterClass="int" resultClass="EveType" >
			SELECT TOP 1 
				invTypes.typeID TypeId
				,invTypes.groupID GroupId
				,invTypes.typeName TypeName
				,invTypes.description Description
				,invTypes.volume Volume
				,invTypes.marketGroupID MarketGroup
				,invGroups.groupName GroupName
				,invMetaGroups.metaGroupName MetaGroupName
				,invMetaGroups.metaGroupID MetaGroupId
			FROM 
				invTypes 
			JOIN
				invGroups ON invGroups.groupID = invTypes.groupID
			LEFT JOIN
				invMetaTypes ON invMetaTypes.typeID = invTypes.typeID
			LEFT JOIN
				invMetaGroups ON invMetaTypes.metaGroupID = invMetaGroups.metaGroupID
			WHERE 
				invTypes.typeID = #typeid#
		</statement>
		
		<statement id="GetEveMarketGroups" parameterClass="int" resultClass="MarketGroup" >
			SELECT  
				marketGroupID GroupId
				,parentGroupID ParentGroupId
				,marketGroupName GroupName
				,description Description
			FROM 
				invMarketGroups 
		</statement>

		<statement id="GetEveRootMarketGroups" resultClass="MarketGroup" >
			SELECT  
				marketGroupID GroupId
				,parentGroupID ParentGroupId
				,marketGroupName GroupName
			FROM 
				windMarketGroups 
			WHERE 
				level = 0
			order by 
				marketGroupName
		</statement>
		
		<statement id="GetEveAllMarketGroups" resultClass="MarketGroup" >
			SELECT  
				marketGroupID GroupId
				,parentGroupID ParentGroupId
				,marketGroupName GroupName
				,level Level
			FROM 
				windMarketGroups 
			order by 
				marketGroupName
		</statement>

		<statement id="GetMarketItemsForGroup" parameterClass="Hashtable" resultClass="EveType" >
			SELECT 
				invTypes.typeID TypeId
				,invTypes.groupID GroupId
				,typeName TypeName
				,invTypes.description Description
				,volume Volume
				,marketGroupID MarketGroup
				,invGroups.groupName GroupName
				,invMetaGroups.metaGroupName MetaGroupName
				,invMetaGroups.metaGroupID MetaGroupId
			FROM 
				invTypes 
			JOIN
				invGroups ON invGroups.groupID = invTypes.groupID
			LEFT JOIN
				invMetaTypes ON invMetaTypes.typeID = invTypes.typeID
			LEFT JOIN
				invMetaGroups ON invMetaTypes.metaGroupID = invMetaGroups.metaGroupID
			WHERE 
				marketGroupID = #group# 
				--AND invMetaTypes.metaGroupID IS NOT NULL 
				--AND invMetaTypes.metaGroupID NOT IN (3,5,6)

				<isNotNull prepend="AND" property="RigSize">
					TypeName like #RigSize# ESCAPE '\'
				</isNotNull>

				<isNotNull property="MetaGroupIds">
					AND invMetaTypes.metaGroupID in 
					<iterate property="MetaGroupIds" open="(" close=")" conjunction=",">
						#MetaGroupIds[]#
					</iterate>
				</isNotNull>
		</statement>
				
		<select id="GetEveItemsByText" parameterClass="string" resultClass="EveType" >
			SELECT 
				invTypes.typeID TypeId
				,invTypes.groupID GroupId
				,invTypes.typeName TypeName
				,invTypes.description Description
				,invTypes.volume Volume
				,invTypes.marketGroupID MarketGroup
				,invGroups.groupName GroupName
				,invMetaGroups.metaGroupName MetaGroupName
				,invMetaGroups.metaGroupID MetaGroupId
			FROM 
				invTypes 
			JOIN
				invGroups ON invGroups.groupID = invTypes.groupID
			LEFT JOIN
				invMetaTypes ON invMetaTypes.typeID = invTypes.typeID
			LEFT JOIN
				invMetaGroups ON invMetaTypes.metaGroupID = invMetaGroups.metaGroupID
			WHERE 
				invTypes.typeName LIKE #text# ESCAPE '\'
				AND invTypes.typeName NOT LIKE '% blueprint%'
			ORDER BY 
				invTypes.typeName
		</select>
	</statements>
</sqlMap>